name: Build "Portable" Mesa-Git (AMD/Intel/NVIDIA + LLVM 21)

on:
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.decide.outputs.should_build }}
      mesa_rev: ${{ steps.sources.outputs.mesa_rev }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install Dependencies
        run: nix profile install nixpkgs#nix-prefetch-git nixpkgs#jq

      - name: Check for source updates. Build if any source changed.
        id: sources
        run: |
          cd pkgs

          # Capture current mesa rev
          OLD_MESA=$(jq -r '.mesa.rev' ./sources.json)
          OLD_LIBDRM=$(jq -r '.libdrm.rev' ./sources.json)
          OLD_WAYLAND=$(jq -r '.["wayland-protocols"].rev' ./sources.json)

          # Run update script
          bash update.sh

          # Capture new revs
          NEW_MESA=$(jq -r '.mesa.rev' ./sources.json)
          NEW_LIBDRM=$(jq -r '.libdrm.rev' ./sources.json)
          NEW_WAYLAND=$(jq -r '.["wayland-protocols"].rev' ./sources.json)

          # Output mesa rev for tagging
          echo "mesa_rev=${NEW_MESA:0:7}" >> $GITHUB_OUTPUT

          # Check if any source changed
          if [ "$OLD_MESA" != "$NEW_MESA" ] || [ "$OLD_LIBDRM" != "$NEW_LIBDRM" ] || [ "$OLD_WAYLAND" != "$NEW_WAYLAND" ]; then
            echo "sources_changed=true" >> $GITHUB_OUTPUT
          else
            echo "sources_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for nixpkgs updates
        id: nixpkgs
        run: |
          OLD_NIXPKGS=$(jq -r '.nodes.nixpkgs.locked.rev // ""' flake.lock)
          nix flake update
          NEW_NIXPKGS=$(jq -r '.nodes.nixpkgs.locked.rev' flake.lock)

          if [ "$OLD_NIXPKGS" != "$NEW_NIXPKGS" ]; then
            echo "nixpkgs_changed=true" >> $GITHUB_OUTPUT
          else
            echo "nixpkgs_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload updated files
        uses: actions/upload-artifact@v4
        with:
          name: updated-sources
          path: |
            pkgs/sources.json
            flake.lock

      - name: Decide if build is needed
        id: decide
        run: |
          if [ "${{ steps.sources.outputs.sources_changed }}" == "true" ]; then
            echo "Sources changed."
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.nixpkgs.outputs.nixpkgs_changed }}" == "true" ]; then
            echo "Nixpkgs changed."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected."
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-mesa:
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      MESA_COMMIT: ${{ needs.check-updates.outputs.mesa_rev }}

    steps:
      - uses: actions/checkout@v4

      - name: Download updated sources
        uses: actions/download-artifact@v4
        with:
          name: updated-sources
          path: .

      - name: Move sources to correct location
        run: |
          mv sources.json pkgs/sources.json 2>/dev/null || true

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build Bundle
        run: nix build .#bundle --out-link bundle-result -L

      - name: Package Artifact
        run: |
          mkdir -p artifact
          cp -rL bundle-result/* artifact/
          cd artifact
          sed -i 's|\("library_path": "\).*/\([^/]*"\)|\1\2|' share/vulkan/icd.d/*.json
          tar -cJvf ../mesa-git-${{ env.MESA_COMMIT }}.tar.xz .

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mesa-git-${{ env.MESA_COMMIT }}
          name: Mesa Git ${{ env.MESA_COMMIT }}
          body: |
            Automated Mesa-git build.

            **Contents:**
            - 64-bit Mesa (`lib/`)
            - 32-bit Mesa (`lib32/`)
            - Vulkan ICDs and layers (`share/`)
            - Bundled LLVM dependencies (`lib/bundled/`, `lib32/bundled/`)

            **Mesa Commit:** `${{ env.MESA_COMMIT }}`
          files: mesa-git-${{ env.MESA_COMMIT }}.tar.xz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit updated sources
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Automated bump of sources and flake.lock"
          file_pattern: "pkgs/sources.json flake.lock"
