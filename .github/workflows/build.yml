name: Build "Portable" Mesa-Git (AMD/Intel/NVIDIA + LLVM 21) + Cache for Nix
env:
  ATTIC_SERVER: ${{ vars.ATTIC_SERVER }}
  ATTIC_TOKEN: ${{ secrets.ATTIC_TOKEN }}
  ATTIC_CACHE: ${{ vars.ATTIC_CACHE }}

on:
  schedule:
    - cron: "0 5 * * *" # Nightly
    - cron: "30 5 * * 3" # Weekly
  workflow_dispatch:
    inputs:
      task:
        description: "Task to run"
        required: true
        default: "build-nightly"
        type: choice
        options:
          - build-nightly
          - promote-to-main

jobs:
  nightly-build:
    if: github.event.schedule == '0 5 * * *' || inputs.task == 'build-nightly'
    runs-on: self-hosted
    outputs:
      mesa_rev: ${{ steps.update.outputs.mesa_rev }}
      changed: ${{ steps.update.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: nightly
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Attic for locally hosted binary cache
        run: |
          nix profile add nixpkgs#attic-client
          attic login local $ATTIC_SERVER $ATTIC_TOKEN
          attic use $ATTIC_CACHE

      - name: Update Sources
        id: update
        run: |
          nix profile add nixpkgs#nix-prefetch-git
          cd pkgs
          OLD_MESA=$(jq -r '.mesa.rev' sources.json)
          bash update.sh
          NEW_MESA=$(jq -r '.mesa.rev' sources.json)

          echo "mesa_rev=${NEW_MESA:0:7}" >> $GITHUB_OUTPUT

          if [ "$OLD_MESA" != "$NEW_MESA" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            nix flake update --flake ..
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Mesa
        if: steps.update.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          # Build and push to Attic
          nix build .#mesa-git .#mesa32-git -L
          nix build .#bundle --out-link bundle-result -L
          attic push $ATTIC_CACHE ./result ./result-1 ./bundle-result

      - name: Build & Package Bundle
        if: steps.update.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
        env:
          MESA_REV: ${{ steps.update.outputs.mesa_rev }}
        run: |
          nix build .#bundle --out-link bundle-result -L
          attic push $ATTIC_CACHE ./bundle-result

          mkdir -p artifact && cp -rL bundle-result/* artifact/ && chmod -R +w artifact

          # Fix ICD paths for portability
          sed -i 's|\("library_path": "\).*/\([^/]*"\)|\1\2|' artifact/share/vulkan/icd.d/*.json

          tar -cJf "mesa-git-${MESA_REV}.tar.xz" -C artifact .

          echo "Bundle complete & archive created!"

      - name: Create Release
        if: steps.update.outputs.changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: mesa-git-${{ steps.update.outputs.mesa_rev }}
          name: "mesa-git-${{ steps.update.outputs.mesa_rev }}"
          prerelease: true
          body: |
            **Automated Nightly Build**

            Contains:
              - 64-bit Mesa (`lib/`)
              - 32-bit Mesa (`lib32/`)
              - Vulkan ICDs and layers (`share/`)
              - Bundled LLVM 21 + dependencies (`lib/bundled/`, `lib32/bundled/`)

          files: mesa-git-${{ steps.update.outputs.mesa_rev }}.tar.xz

      - name: Commit Updates
        if: steps.update.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "nightly: ${{ steps.update.outputs.mesa_rev }}"
          branch: nightly
          file_pattern: "pkgs/sources.json flake.lock"

  promote-to-main:
    if: github.event.schedule == '30 5 * * 3' || inputs.task == 'promote-to-main'
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge Nightly â†’ Main
        id: merge
        run: |
          git fetch origin nightly

          NIGHTLY_REV=$(git log origin/nightly -1 --format=%s | grep -oP '(?<=nightly: )[a-f0-9]+' || echo "unknown")
          echo "mesa_rev=${NIGHTLY_REV}" >> $GITHUB_OUTPUT

          if git merge-base --is-ancestor origin/nightly HEAD; then
            echo "Main is already up to date with nightly"
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          git merge --ff-only origin/nightly || git merge origin/nightly -m "promote: ${NIGHTLY_REV}"
          echo "skipped=false" >> $GITHUB_OUTPUT

      - name: Push Main
        if: steps.merge.outputs.skipped != 'true'
        run: git push origin main

      - name: Create Stable Release
        if: steps.merge.outputs.skipped != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.merge.outputs.mesa_rev }}
          name: "mesa-git-${{ steps.merge.outputs.mesa_rev }}"
          prerelease: false
          body: |
            **Weekly Stable Release**

            Mesa commit: `${{ steps.merge.outputs.mesa_rev }}`

            This build has been running on the nightly branch without reported issues.

            **Portable Download:**
            [Download Artifact from Nightly Release](https://github.com/${{ github.repository }}/releases/tag/nightly-${{ steps.merge.outputs.mesa_rev }})

            ### NixOS Usage
            #
            {
              inputs.mesa-git.url = "github:powerofthe69/mesa-git-nix";
              # ...
              nixpkgs.overlays = [ inputs.mesa-git.overlays.default ];
              drivers.mesa-git.enable = true;
            }
